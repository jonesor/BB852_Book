## Exercise Solutions: Temperature effects on egg laying dates

```{r prepare data, eval = FALSE, echo=FALSE, ,warning=FALSE,message=FALSE}
#Here I am preparing the data for the course
#I have set eval = FALSE because I have already done this.
library(tidyverse)
sduBirds <- read.csv("~/Dropbox/_SDU_Teaching/BB852/CourseData/sduBirds.csv")

#Process to get first egg date
#First egg, data preparation ------------
sduBirds %>%
  mutate(nEggs = as.numeric(as.character(nEggs))) %>%
  select(Timestamp,Year,Day,boxNumber,nEggs) %>%
  filter(nEggs > 0) %>%
  group_by(Year,boxNumber) %>%
  filter(Day==min(Day)) %>%
  ungroup()%>%
  mutate(estimatedFirstEggDate = Day - nEggs, dummy=1) %>%
  mutate(Year = as.factor(Year)) %>%
  arrange(estimatedFirstEggDate)  %>%
  arrange(Year)%>%
  group_by(Year)%>%
  mutate(cumulativeCount=cumsum(dummy)) %>% 
  select(-dummy) %>%
  ungroup() %>%
  mutate(Year =as.numeric(as.character(Year))) %>%
  select(boxNumber, Year, estimatedFirstEggDate) %>%
  rename(firstEgg=estimatedFirstEggDate) %>%
  arrange(boxNumber,Year) %>%
  spread(Year,firstEgg) -> xx

names(xx)[2:ncol(xx)] <- paste0("y",names(xx)[2:ncol(xx)])
write.csv(xx,"~/Dropbox/_SDU_Teaching/BB852/CourseData/eggDates.csv",row.names = FALSE)

#Prep weather
weather <- read.csv("/Users/jones/Dropbox/_SDU_Birds/Data/SDUweather.csv") %>%
  select(YEAR, MONTH, DAY, TEMP)

write.csv(weather,"~/Dropbox/_SDU_Teaching/BB852/CourseData/AarslevTemperature.csv",row.names = FALSE)
```


### Preparing the bird data



1. Import the data and take a look at it  with `head` or `str`.

```{r, eval=TRUE}
eggDates <- read.csv("CourseData/eggDates.csv")
```
```{r}
head(eggDates)
```

2. Use `pivot_longer` to reformat the data. This might take a bit of trial and error - don't give up! 

Maybe this will help: The first argument in the `pivot_longer` command (`cols`) tells R which columns contain the data you are interested in (in this case, these are `y2013`,`y2014` etc). Then the `names_to` argument tells R what you want to name the new column from this data (in this case, `Year`). Then, the `values_to` argument tells R what the data column should be called (e.g. `Day`). In addition, there is a useful argument called `names_prefix` that will remove the part of the column name  (e.g. the `y` of `y2013`)

You should end up with a dataset with three columns as described above.
```{r}
eggDates %>% 
pivot_longer(cols = c(y2013,y2014,y2016,y2017,y2018,y2019),names_to = c("Year"),values_to = "Day",names_prefix = "y")
```

There is, in fact, a slightly easier way to do this with a "helper function", `starts_with`. This picks out all columns that start with particular text.

```{r}
eggDates %>% 
pivot_longer(cols = starts_with("y"),names_to = c("Year"),values_to = "Day",names_prefix = "y")
```


3. Calculate the mean egg date per year using `summarise` (remember to `group_by` the year first). Take a look at the data.

```{r}
eggDates %>% 
  pivot_longer(cols = starts_with("y"),names_to = c("Year"),values_to = "Day",names_prefix = "y") %>% 
  group_by(Year) %>% 
  summarise(meanEggDate = mean(Day,na.rm = TRUE))
```

You should now remember to create a new object to hold the result of this sequence of pipes.

```{r}
meanEggDates <- eggDates %>% 
  pivot_longer(cols = starts_with("y"),names_to = c("Year"),values_to = "Day",names_prefix = "y") %>% 
  group_by(Year) %>% 
  summarise(meanEggDate = mean(Day,na.rm = TRUE))
```

### Preparing the weather data


4. Import the weather data and take a look at it with `head` or `str`.

```{r}
weather <- read.csv("CourseData/AarslevTemperature.csv")
```

5. Use `filter` subset to the months of interest (February-April) and then `summarise` the data to calculate the mean temperature in this period (remember to `group_by` year). Look at the data. You should end up with a dataset with two columns - `year` and `meanSpringTemp`. 

```{r}
weather <- weather %>%
  filter(MONTH %in% 2:4) %>%
  group_by(YEAR) %>%
  summarise(meanAprilTemp = mean(TEMP))
weather
```

### Joining the two datasets

6. Join the two datasets together using `left_join`. You should now have a dataset with columns `nestNumber`, `Year`,  `dayNumber` and `meanAprilTemp`

```{r}
joinedData <- left_join(meanEggDates,weather,c("Year" = "YEAR"))
head(joinedData)
```


### Plot the data

7. plot a graph of `meanAprilTemp` on the x-axis and `dayNumber` on the y-axis.

```{r}
plot(joinedData$meanAprilTemp,joinedData$meanEggDate)
```

Now you should be able to answer the question we started with: is laying date associated with spring temperatures.
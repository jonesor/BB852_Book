## Exercise Solutions: Temperature effects on egg laying dates

```{r prepare data, eval = FALSE, echo=FALSE, ,warning=FALSE,message=FALSE}
#Here I am preparing the data for the course
#I have set eval = FALSE because I have already done this.
library(tidyverse)
sduBirds <- read.csv("~/Dropbox/_SDU_Teaching/BB852/CourseData/sduBirds.csv")

#Process to get first egg date
#First egg, data preparation ------------
sduBirds %>%
  mutate(nEggs = as.numeric(as.character(nEggs))) %>%
  select(Timestamp,Year,Day,boxNumber,nEggs) %>%
  filter(nEggs > 0) %>%
  group_by(Year,boxNumber) %>%
  filter(Day==min(Day)) %>%
  ungroup()%>%
  mutate(estimatedFirstEggDate = Day - nEggs, dummy=1) %>%
  mutate(Year = as.factor(Year)) %>%
  arrange(estimatedFirstEggDate)  %>%
  arrange(Year)%>%
  group_by(Year)%>%
  mutate(cumulativeCount=cumsum(dummy)) %>% 
  select(-dummy) %>%
  ungroup() %>%
  mutate(Year =as.numeric(as.character(Year))) %>%
  select(boxNumber, Year, estimatedFirstEggDate) %>%
  rename(firstEgg=estimatedFirstEggDate) %>%
  arrange(boxNumber,Year) %>%
  spread(Year,firstEgg) -> xx

names(xx)[2:ncol(xx)] <- paste0("y",names(xx)[2:ncol(xx)])
write.csv(xx,"~/Dropbox/_SDU_Teaching/BB852/CourseData/eggDates.csv",row.names = FALSE)

#Prep weather
weather <- read.csv("/Users/jones/Dropbox/_SDU_Birds/Data/SDUweather.csv") %>%
  select(YEAR, MONTH, DAY, TEMP)

write.csv(weather,"~/Dropbox/_SDU_Teaching/BB852/CourseData/AarslevTemperature.csv",row.names = FALSE)
```


### Preparing the bird data



1. Import the data and take a look at it  with `head` or `str`.

```{r, eval=TRUE}
eggDates <- read.csv("CourseData/eggDates.csv")
```
```{r}
head(eggDates)
```

2. Use `pivot_longer` to reformat the data. This might take a bit of trial and error - don't give up! 

Maybe this will help: The first argument in the gather command indicates what the columns in the main data represent (i.e. here the column represents "Year"). The second argument is the name you would give to the actual data (i.e. "day", in this case). The final argument then tells the function which columns of the data are not to be rearranged (i.e. "boxNumber" in this case).

You should end up with a dataset with three columns as described above.
```{r}
eggDates %>% 
pivot_longer(cols = c(y2013,y2014,y2016,y2017,y2018,y2019),names_to = c("Year"),values_to = "Day")
```

There is, in fact, an easier way to do this with a "helper function", `starts_with`.

```{r}
eggDates %>% 
pivot_longer(cols = starts_with("y"),names_to = c("Year"),values_to = "Day")
```


3. Ensure that year is coded as numeric variable using `mutate`. [Hint, you can use the command `as.numeric`, but first remove the "y" in the name using `gsub`].

```{r}
eggDates %>% 
  pivot_longer(cols = starts_with("y"),names_to = c("Year"),values_to = "Day") %>% 
  mutate(Year = gsub(pattern = "y",replacement = "", x = Year)) %>% 
  mutate(Year = as.numeric(Year))
```

4. Calculate the mean egg date per year using `summarise` (remember to `group_by` the year first). Take a look at the data.

```{r}
eggDates %>% 
  pivot_longer(cols = starts_with("y"),names_to = c("Year"),values_to = "Day") %>% 
  mutate(Year = gsub(pattern = "y",replacement = "", x = Year)) %>% 
  mutate(Year = as.numeric(Year)) %>% 
  group_by(Year) %>% 
  summarise(meanEggDate = mean(Day,na.rm = TRUE))
```

You should now remember to create a new object to hold the result of this sequence of pipes.

```{r}
meanEggDates <- eggDates %>% 
  pivot_longer(cols = starts_with("y"),names_to = c("Year"),values_to = "Day") %>% 
  mutate(Year = gsub(pattern = "y",replacement = "", x = Year)) %>% 
  mutate(Year = as.numeric(Year)) %>% 
  group_by(Year) %>% 
  summarise(meanEggDate = mean(Day,na.rm = TRUE))
```

### Preparing the weather data


5. Import the weather data and take a look at it with `head` or `str`.

```{r}
weather <- read.csv("CourseData/AarslevTemperature.csv")
```

6. Use `filter` subset to the months of interest (February-April) and then `summarise` the data to calculate the mean temperature in this period (remember to `group_by` year). Look at the data. You should end up with a dataset with two columns - `year` and `meanSpringTemp`. 

```{r}
weather <- weather %>%
  filter(MONTH %in% 2:4) %>%
  group_by(YEAR) %>%
  summarise(meanAprilTemp = mean(TEMP))
weather
```

### Joining the two datasets

7. Join the two datasets together using `left_join`. You should now have a dataset with columns `nestNumber`, `Year`,  `dayNumber` and `meanAprilTemp`

```{r}
joinedData <- left_join(meanEggDates,weather,c("Year" = "YEAR"))
head(joinedData)
```


### Plot the data

8. plot a graph of `meanAprilTemp` on the x-axis and `dayNumber` on the y-axis.

```{r}
plot(joinedData$meanAprilTemp,joinedData$meanEggDate)
```

Now you should be able to answer the question we started with: is laying date associated with spring temperatures.
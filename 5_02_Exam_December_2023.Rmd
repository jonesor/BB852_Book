# Exam December 2023



```{block 5-02-Exam-December-2023-1, type="do-something"}

**Read these instructions carefully**

This exam includes four questions that test different aspects of your learning during this course: data wrangling, data visualisation and statistics. Each question is broken down into a number sub-questions. 

Your work should be handed in as a single PDF, and the filename should include your name or username (e.g. "__BB852 Exam Harry Potter.pdf__". 
The number of each question should be clearly indicated, and the answer to each question should start on a new page.

For each question you must provide the R code you used to answer the question. The code should include comments to explain what you are doing. The code should be provided as text using a fixed-width font such as `Courier`. The rest of your answers should be in another font (e.g. Times New Roman, Cambria). Please use *text* rather than a screenshot of your code.

* Plots and tables should have appropriate captions. 
* Plots should be produced using `ggplot`.
* Data manipulation should be done using `dplyr` tools you have learned in the class.
* Remember that you can make "panels" of plots (e.g. Fig 1A, B).
* Axis labels are important. Sometimes you may want to edit them to be different from a data column name.
* Reporting of any statistics should be appropriate to the type of analysis you have done. There are examples in the course materials.
* Reporting of methods and results should be written in the style of a scientific paper (again, there are examples in the course materials).

*If you don't understand any aspects of the questions, please ask for help!*


**You MUST submit your work via itsLearning (not email!).**
```

```{r 5-02-Exam-December-2023-2,echo=FALSE,message=FALSE}
library(tidyverse)
library(ggfortify)

options(dplyr.summarise.inform = FALSE)
```

<!-- Data wrangling and graphing -->
## Question 1: Wine quality and climate  (10 points)

The datasets `winesSpain.csv` and `SpainSurfaceTemp.csv` contain records of wine ratings from various regions in Spain and surface temperature data in Spain, respectively. The wine dataset includes columns for year, region, and rating. The temperature dataset includes year and average temperature. In this question you will investigate graphically how wine rating varies with region and with year. 

a) Using the first data set, filter out non-vintage wines (where year is recorded as "N.V.") and all records from before 1980. Summarise the data to produce a table showing, for each region (i) the number of data points, (ii) the mean quality (iii) the standard deviation of the quality. Arrange the table so that it is ordered by number of data points, highest number first. Make a nicely formatted table that includes the top 10 rows of the data in your report.

b) Select the two regions with most data points. Then make a plot showing how the average wine rating has changed through time in the two regions. Use `geom_smooth` to add trend lines. 

c) Select one of the two regions most data-rich regions and explore how the average wine rating correlates with the average temperature in Spain during the period 1980 onwards. You will need to merge the wine data with the temperature data for this analysis. Make a suitable plot to illustrate any relationship between wine quality and temperature for the region. 


<!-- Randomisation test -->
## Question 2: Foraging in Blackbird (10 points)

Researchers are conducting a study to investigate the effect of increasing temperatures associated with climate change on the foraging behaviour of the Eurasian Blackbird (*Turdus merula*). The researchers are interested in understanding how rising temperatures may influence the foraging times of blackbirds.

Their hypothesis is that, in the context of climate change, increasing temperatures in the winter will lead to reduced energy expenditure for thermoregulation in the Eurasian blackbird, resulting in decreased foraging times.

To test this hypothesis, an experiment was designed wherein two groups of captive Eurasian blackbirds was observed: a control group experiencing current ambient temperatures and a treatment group exposed to higher temperatures (+2 degrees C) using heat lamps simulating projected climate change conditions. 

Researchers recorded the foraging time of the blackbirds over a one-week period and calculated the proportion of time spent actively foraging. These data are available to you in the file `blackbird_foraging.csv`. Note that the data may need correcting (using R) before use.

a) Examine the data using tables/plots.

b) Plot the data to compare foraging times between the control and treatment groups.

c) Conduct a randomization test to determine if there is a significant difference in foraging times. Write (i) a brief method description and (ii) a summary of the results. Write in the style of a scientific paper.

```{r 5-02-Exam-December-2023-3, echo = FALSE, message=FALSE}

set.seed(42)  # Setting a seed for reproducibility
require(ggplot2)
require(dplyr)

# Simulating data for the control group
control_group <- data.frame(group = rep("Control", 15),
                            foragingTime = rnorm(15, mean = 0.6, sd = 0.1))

# Simulating data for the treatment group
treatment_group <- data.frame(group = rep("Treatment", 15),
                              foragingTime = rnorm(15, mean = 0.4, sd = 0.2))

# Combining the data from both groups
simulated_data <- rbind(control_group, treatment_group) %>% 
  mutate(foragingTime = round(foragingTime, digits =3)) %>% 
  mutate(ringNumber = paste0("CX",sample(1000:4000, size = n())))

# Add some dodgy data that should be excluded
tempX <- sample(which(simulated_data$group == "Control"), size = 2)
simulated_data$group[tempX] <- "contrl"

#head(simulated_data)
#ggplot(simulated_data,aes(x = group, y = foragingTime)) + geom_boxplot()
#t.test(foragingTime~group,data = simulated_data)

# Saving the data to a CSV file
# Add some dodgy data that should be corrected
tempX <- sample(which(simulated_data$group == "Control"), size = 2)
simulated_data$group[tempX] <- "contrl"

tempX <- sample(which(simulated_data$group == "Control"), size = 2)
simulated_data$foragingTime[sample(30,1)] <- NA

write.csv(simulated_data, file = "DataSetLibrary/blackbird_foraging.csv", row.names = FALSE)
```


<!-- Power analysis -->
## Question 3: Habitat restoration (10 points)

You are part of a research team that aims to investigate the effects of habitat restoration on the average body mass of a specific bird species. You hypothesise that restored habitats may support healthier bird populations that have a larger body mass. Your task is to plan a study to robustly test this hypothesis.

The data file `habitat_restoration.csv`, contains data from a pilot on average bird body size (in grams) from the non-restored habitat.


```{r 5-02-Exam-December-2023-4, echo = FALSE, message=FALSE}
# R Code for Simulating the Dataset
round_to_nearest_half <- function(x) {
  round(x * 2) / 2
}

set.seed(789) # Ensure reproducibility
body_size_non_restored <- rnorm(47, mean = 150, sd = 20)  # Average body size in restored habitats
body_size_non_restored <- round_to_nearest_half(body_size_non_restored)

habitat_restoration <- data.frame(BodySize = body_size_non_restored)
write.csv(habitat_restoration, "DataSetLibrary/habitat_restoration.csv", row.names = FALSE)

#require(ggplot2)
#ggplot(habitat_restoration,aes(x = BodySize)) + geom_histogram()

```

a) Summarise the pilot study data to obtain the information necessary required to conduct a power analysis.
b) Conduct a power analysis using simulation techniques. The objective is to determine the sample size required to achieve 80% power to detect a 20% increase in average bird body size in rewilded habitats compared to non-rewilded habitats.
c) Write a description of the methods used for the power analysis. Then present the results in a clear, concise manner. Interpret these results, discussing their implications for the design and feasibility of the proposed study. Ensure that the communication is professional and suitable for a scientific project plan.


<!-- GLM analysis -->
## Question 4: Nesting success in urban areas

The interplay between habitat characteristics and species survival is a fundamental theme in ecology, particularly in the context of increasingly urbanized landscapes. Your colleagues have made a study that looks at how habitat type and food availability (a critical component of habitat quality) influence bird nesting success in urban and suburban environments. Such an investigation is vital for understanding ecological principles like resource availability, habitat suitability, and species adaptability in increasingly urbanised landscapes.

The dataset `bird_nesting_success.csv` presents a unique opportunity to explore these dynamics. It comprises data from different urban habitats, each presenting different challenges and opportunities for avian species. The key variables in this dataset include:

*	`nestSuccess`: A binomial variable where 1 represents a successful nest and 0 an unsuccessful one, reflecting the reproductive success of birds, a crucial indicator of population health in ecology.
* `habitatType`: Classifies the habitat where the nest is located (urban forest, park, urban garden), each representing distinct ecological niches with varying degrees of naturalness and anthropogenic influence.
* `foodAvailability`: The biomass (in grams) of insects collected in a nearby trap over a 2-day period. This is a direct measure of resource availability, essential for understanding the role of food in nesting success.

The primary aim is to assess how variations in habitat type and food availability impact the reproductive success of birds in different urban settings.  The following tasks are proposed:

a) Create a suitable plot that illustrates the relationship between nesting success and food availability, with a clear distinction between the habitat types.

b) Use a suitable statistical model to analyse the influence of habitat type and food availability on nest success. Describe (i) the methodology and (ii) summarize the findings in a format appropriate for a scientific report or thesis.

c) Produce a plot that shows (in addition to the raw data points) the fitted values produced by your model and the uncertainty in those estimates. 

```{r 5-02-Exam-December-2023-5, echo = FALSE, message=FALSE}
# Simulate the data
# Set the seed for reproducibility
set.seed(123)

# Define a data frame with parameters for each line
parameters <- data.frame(
  habitat = c('park', 'urbanForest', 'urbanGardens'),
  beta0 = c(-1.2, -1, 0.3), # Intercepts on the logit scale for each line
  beta1 = c(0.01, 0.05, 0.02) # Slopes on the logit scale for each line
)

# Define the number of data points to simulate
n <- 100

# Generate a sequence of 'food' values
food <- runif(n = n, 2, 10) * 10

# Initialize an empty data frame to store all the data
all_data <- data.frame()

# Function to simulate data based on specified parameters
simulate_data <- function(beta0, beta1, food_values) {
  logit <- beta0 + beta1 * food_values
  prob <- 1 / (1 + exp(-logit))
  success <- rbinom(length(food_values), size = 1, prob = prob)
  
  return(data.frame(food = food_values, success = success, probability = prob))
}

# Loop over each set of parameters
for(i in 1:nrow(parameters)) {
  # Simulate data for the current line
  line_data <- simulate_data(parameters$beta0[i], parameters$beta1[i], food)
  
  # Add the line color to the data frame
  line_data$habitat <- parameters$habitat[i]
  
  # Append to the master dataset
  all_data <- rbind(all_data, line_data)
}

all_data <- all_data %>% 
  select(-probability) %>% 
  mutate(food = round(food,2))

names(all_data) <- c("foodAvailability", "nestSuccess", "habitatType")

# Write out the combined dataset
write.csv(all_data, "DataSetLibrary/bird_nesting_success.csv", row.names = FALSE)

# ggplot(all_data,aes(x = food, y = probability, colour = habitat)) + geom_line() + ylim(0,1)
# #ggplot(all_data,aes(x = food, y = survival, colour = habitat)) + geom_jitter() + ylim(0,1)
# 
# mod1 <- glm(success ~ food*habitat, family = "binomial", data = all_data)
# summary(mod1)
# anova(mod1, test = "Chi")

```




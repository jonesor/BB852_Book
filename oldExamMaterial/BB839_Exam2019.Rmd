---
title: "BB839 Exam 2019"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
classoption: a4paper
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This exam includes four questions that test different aspects of your learning during this course: data wrangling, data visualisation and statistics. Each question is broken down into a number sub questions. 

**You must answer questions 1-3; you must answer EITHER question 4 OR 5**

Your work should be handed in as a single PDF. Each question should be clearly indicated

For each question you must provide the R code you used to answer the question. The code should include comments to explain what you are doing. The code should be provided as text using a fixed-width font such as `Courier`. The rest of your answers should be in another font (e.g. Times New Roman, Cambria, Ariel).
You can use the Microsoft Word template provided alongside these questions as guidance.


* Plots and tables should have captions. 
* Plots should be produced using `ggplot`.
* Axis labels are important.
* Reporting of any statistics should be appropriate to the type of analysis you have done.
* Reporting of methods and results should be written in the style of a scientific paper.


*If you don't understand what is required for any of these questions you are encouraged to ask for help.*

**Hand in deadline is Friday 10th January 2020 at 12:00 CET**

**You MUST submit your work via Blackboard (not email!)**

```{r,echo=FALSE,message=FALSE}
library(tidyverse) 
```

### 1) Data wrangling life history data (10 points)

The Anage database (`anage_data.csv`) is a large collection of data on the life history of animals. It includes information on life span, body size, generation time etc. for species from a wide range of taxonomic groups. In this question you will be using this data to produce a graph and some summary information. You may need to `filter`, `select`, `mutate` or otherwise manipulate the data before you use it. You may also like to rename some of the data columns for ease of use. 

The length of gestation in humans is 9 months, but it varies across mammals. Gestation time (`Gestation.Incubation..days.`) is positively associated with birth weight (`Birth.weight..g.`), which makes sense since larger bodies take longer to build. It is interesting to consider if there are differences in this relationship between rodents (Order Rodentia) and their flying cousins - bats (Order Chiroptera). 

a) Produce a graph showing the relationship between between the log transformed birth weight (x-axis) and log-transformed gestation length in days (y-axis) for bats and rodents.

b) Produce a table showing the minimum, maximum, mean and median gestation times (in days) for rodents and bats.

c) Which are the species (latin names) with the minimum and maximum gestation lengths in Rodentia and Chiroptera?

d) Explain why an ordinary least squares regression would not be the best approach to analyse this relationship.


```{r echo = FALSE, eval = FALSE}
#A

setwd("/Users/jones/Dropbox/_SDU_Teaching/BB839 New Stats Course/")
anage <- read.csv("CourseData/anage_data.csv")

str(anage)

x <- anage %>% 
  select(Class,Order,Family, Genus, Species,Birth.weight..g.,Gestation.Incubation..days.,Litter.Clutch.size) %>% 
  filter(Order %in% c("Chiroptera","Rodentia")) %>% 
  rename(birthWeight = Birth.weight..g.,gestation = Gestation.Incubation..days.,litterSize = Litter.Clutch.size)

ggplot(x,aes(x = log(birthWeight), y = log(gestation),colour=Order)) + 
  geom_point() + 
  xlab("log(birth weight, grams)") +
  ylab("log(gestation duration, days)")

#B
x %>% 
  group_by(Order) %>% 
  summarise(minGestation = min(gestation,na.rm=TRUE),maxGestation = max(gestation,na.rm=TRUE),
            meanGestation = mean(gestation,na.rm=TRUE),medianGestation = median(gestation,na.rm=TRUE)) 

# C 
x %>% 
  mutate(species = paste(Genus,Species)) %>% 
  select(Order,species,gestation) %>% 
  filter(Order == "Chiroptera" & gestation == 275)

x %>% 
  mutate(species = paste(Genus,Species)) %>% 
  select(Order,species,gestation) %>% 
  filter(Order == "Chiroptera" & gestation == 35)

x %>% 
  mutate(species = paste(Genus,Species)) %>% 
  select(Order,species,gestation) %>% 
  filter(Order == "Rodentia" & gestation == 253)

x %>% 
  mutate(species = paste(Genus,Species)) %>% 
  select(Order,species,gestation) %>% 
  filter(Order == "Rodentia" & gestation == 15)

#An OLS regression is not appropriate because the points are not independent. They are related via the phylogeny.
```

### 2) Industrial melanism (10 points)

Industrial melanism is a famous example of an evolutionary effect where dark pigmentation (melanism) evolves via natural selection where the environment is polluted with soot deposits. Darker individuals have a higher fitness in areas where their camouflage matches the polluted background surfaces better.

Some biologists have claimed that the knot grass moth (*Acronicta rumicis*) shows industrial melanism. You have collected data on the percentage of moths collected in light traps that are of the dark morph (`melanism.csv`). Your expectation is that you will find a higher percentage of dark morphs in the city where there is more pollution.

a) plot the data (e.g. with a box plot)

b) carry out a randomisation test to determine if there is a significant difference in the frequency of the dark morph between city and countryside. Write (i) a brief method description and (ii) a summary of the results. 

```{r echo = FALSE, eval = FALSE}
melanism <- data.frame(habitat = rep(c("city","countryside"),each = 8),percentDark = c(76,67,34,86,56,46,73,12,45,76,25,04,34,76,31,19))

write.csv(x,file = "/Users/jones/Dropbox/_SDU_Teaching/BB839 New Stats Course/CourseData/melanism.csv",row.names = FALSE)

####

setwd("/Users/jones/Dropbox/_SDU_Teaching/BB839 New Stats Course/")

fish <- read.csv("CourseData/melanism.csv")

ggplot(melanism,aes(x = habitat,y = percentDark))+
  geom_boxplot()

obsDiff <- diff(melanism %>% 
                  group_by(habitat) %>% 
                  summarise(meanPerc = mean(percentDark)) %>% 
                  pull(meanPerc))

diffs <- replicate(5000,diff(melanism %>% 
                               mutate(habitat = sample(habitat)) %>% 
                               group_by(habitat) %>% 
                               summarise(meanPerc = mean(percentDark)) %>% 
                               pull(meanPerc)))

sum(abs(diffs) > abs(obsDiff))/5000

t.test(percentDark~habitat,data = melanism)


```




### 3) Power in a planned experiment (10 points)

You are planning an experiment testing how the behaviour of small fish is affected by exposure to danger from predators. There are two treatments: (i) "exposed to predator cues" (from video footage of large predatory fish) and (ii) a "control" treatment, which is a safe predator-free environment. You would like to be able to detect a 20% reduction in swimming distance.

You record behaviour as the distance in meters travelled by fish as they swim around their tank within a 5 minute observation window. You hypothesise that when exposed to predator cues the fish will cover less distance and will tend to hide among the rocks and plants in the tank more. You have 5 fish tanks available for your study.

You have some preliminary data from a pilot study (`fishFear.csv`) which shows the distances moved by several individuals in a single pilot study.


```{r,echo = FALSE, eval = FALSE,message = FALSE}
set.seed(123)
x<-data.frame(id = 1:10,distance = round(rnorm(10,2,0.5),2))
write.csv(x,file = "/Users/jones/Dropbox/_SDU_Teaching/BB839 New Stats Course/CourseData/fishFear.csv",row.names = FALSE)
```

a) Summarise the pilot study data to obtain mean and standard deviation.

b) Conduct a power analysis based on the pilot study data to estimate the number of samples required to carry out your experiment with 80% power. Describe the results of this power analysis.

c) Describe how you might carry out your study, given your findings and the facilities available to you.

```{r echo = FALSE, eval = FALSE}
setwd("/Users/jones/Dropbox/_SDU_Teaching/BB839 New Stats Course/")

fish <- read.csv("CourseData/fishFear.csv")
mean(fish$distance)
sd(fish$distance)


meanDist <- mean(fish$distance)
sdDist <- sd(fish$distance)

powerResults <- data.frame(sampleSize = 5:30)

powerResults$power <- NULL
for(i in 1:nrow(powerResults)){
pvals <- replicate(1000,t.test(rnorm(powerResults$sampleSize[i], mean = meanDist,sd = sdDist),
       rnorm(powerResults$sampleSize[i], mean = meanDist*0.8,sd = sdDist))$p.value)

powerResults$power[i]<-sum(pvals<0.05)/1000
}

head(powerResults)

ggplot(powerResults,aes(x = sampleSize,y=power))+
  geom_point()+
  geom_line()
```



### 4) The Titanic (20 points)

The `titanic.csv` data set includes a range of data on a subset of the passengers on the Titanic that sank in 1920 after hitting an iceberg. There were approximately 2200 passengers and crew on board and >1400 of these people died. 

Your task is to analyse the data to find out how passenger class (`Pclass`) and gender (`Sex`) influenced survival probability. Survival is indicated with the numeric values 0 (died) and 1 (survived). Passenger class has values of 1, 2 or 3 and Sex is recorded as `male` or `female`.

a) Produce an appropriate graph of the raw data that illustrates survival differences among passenger classes and genders.

b) Fit a suitable statistical model to estimate survival probability among passenger class and genders. Describe the method and then summarise the results produced by the model.

c) Make a plot showing the model's estimates and their 95% confidence intervals.

```{r echo = FALSE, eval = FALSE}
#Titanic

setwd("/Users/jones/Dropbox/_SDU_Teaching/BB839 New Stats Course/")

titanic <- read.csv("CourseData/titanic.csv") 

titanic <- titanic %>% 
  mutate(Pclass = as.factor(Pclass)) %>% 
  mutate(Survived = as.factor(Survived))

(A<-ggplot(titanic,aes(x = Pclass,y = Survived,colour=Sex))+geom_jitter(alpha = 0.75))


head(titanic)

modA <- glm(Survived ~ Sex+ Pclass +Sex:Pclass,data = titanic,family = binomial)
library(ggfortify)
autoplot(modA)

anova(modA,test="Chi")
summary(modA)

newDat <- expand.grid(Pclass = c("1","2","3"),Sex = c("male","female"))

pv <- predict(modA,newdata = newDat,se.fit = TRUE)
library(tidyverse)

newDat <- newDat %>% 
  mutate(survival_LP = pv$fit,
         lowerCI_LP = pv$fit - 1.96*pv$se.fit,
         upperCI_LP = pv$fit + 1.96*pv$se.fit)

inverseFunction <- family(modA)$linkinv

newDat <- newDat %>% 
  mutate(survival = inverseFunction(survival_LP)) %>% 
  mutate(lowerCI = inverseFunction(lowerCI_LP)) %>% 
  mutate(upperCI = inverseFunction(upperCI_LP)) 

newDat
(B <- ggplot(newDat,aes(x = Pclass,y = survival,colour=Sex))+
  geom_point() +
  geom_segment(aes(xend = Pclass,y = lowerCI,yend = upperCI)))

#ggpubr::ggarrange(A,B,ncol=2)  

```

### 5) Elephant poaching (20 points) 

Illegal poaching activity is a major problem for African elephant conservation. You are provided with some data from some nature reserves across southern Africa (`elephantPoaching.csv`). 

The data includes the number of elephants killed in 2016 (`nkilled`) and the number of scouts (the guards that protect the elephants) (`scoutPerKm`). A philanthropist billionnaire has been working in the area to provide additional tools to some reserves such as drones, high-tech communications and additional vehicles. This funding is recorded in the dataset column `funding` as `funded` (the ordinary parks with no extra funding are recorded as `normal`). 

Use an appropriate statistical model to explore the relationship between elephants killed and the amount of cover provided by guards. Does this relationship differ depending on how well equipped the guards are?

```{r echo = FALSE, eval = FALSE}
#Generate dataset
set.seed(125)
samplesize = 12
x<-data.frame(scoutPerKm = sort(c(runif(samplesize,0,15)))) %>% 
  mutate(lognkilled = (scoutPerKm*(-.2))+3.5) %>% 
  mutate(lognkilled = lognkilled+rnorm(samplesize,0,1)) %>% 
  mutate(nkilled = round(exp(lognkilled))) %>% 
  mutate(funding = "normal")

set.seed(1224)
samplesize = 8
x2<-data.frame(scoutPerKm = sort(c(runif(samplesize,0,15)))) %>% 
  mutate(lognkilled = (scoutPerKm*(-.25))+2.5) %>% 
  mutate(lognkilled = lognkilled+rnorm(samplesize,0,1)) %>% 
  mutate(nkilled = round(exp(lognkilled))) %>% 
  mutate(funding = "funded")

x3 <- rbind(x,x2) %>% 
  mutate(scoutPerKm = scoutPerKm/500)

x3 <- select(x3,scoutPerKm,funding,nkilled)
#setwd("/Users/jones/Dropbox/_SDU_Teaching/BB839 New Stats Course/")
write.csv(x3,file = "/Users/jones/Dropbox/_SDU_Teaching/BB839 New Stats Course/CourseData/elephantPoaching.csv",row.names = FALSE)
```

a) Plot the data to show the relationship between the the number of scouts per unit area of park and the number of elephants killed. Colour code the points by whether the park management received extra funding or not.

b) Fit a suitable statistical model to estimate the statistical relationship between guards per km, funding, and elephant deaths. Describe the method and then summarise the results produced by the model.

c) Produce a plot that shows (in addition to the raw data points) the fitted values produced by your model and the uncertainty in those estimates.

```{r echo = FALSE, eval = FALSE}
setwd("/Users/jones/Dropbox/_SDU_Teaching/BB839 New Stats Course/")

eleph <- read.csv("CourseData/elephantPoaching.csv")
ggplot(x3,aes(x=scoutPerKm,y = nkilled,colour=funding)) + 
  geom_point()


modA <- glm(nkilled ~ scoutPerKm + funding + scoutPerKm:funding,data = x3,family = poisson)
anova(modA,test="Chi")
library(ggfortify)
autoplot(modA)


summary(modA)


#Create a data frame to predict from.
newData <- expand.grid(scoutPerKm = seq(0,0.03,0.001),funding = c("funded","normal"))

#Predict from the model using newData.
pv <- predict(modA,newData,se.fit =TRUE)

#Add predicted values (on scale of linear predictor).
newData <- newData %>% 
  mutate(nKilled_LP = pv$fit) %>% 
  mutate(lower_LP = pv$fit - 1.96*pv$se.fit) %>% 
  mutate(upper_LP = pv$fit + 1.96*pv$se.fit)

#get inverse function.
inverseLink <- family(modA)$linkinv

#Apply inverse function to the predicted values.

newData <- newData %>% 
  mutate(nkilled = inverseLink(nKilled_LP)) %>% 
  mutate(lowerCI = inverseLink(lower_LP)) %>% 
  mutate(upperCI = inverseLink(upper_LP))

#plot with ribbons, lines and points.
ggplot(x3,aes(x=scoutPerKm,y = nkilled,colour=funding)) + 
  geom_ribbon(data = newData,aes(x = scoutPerKm,ymin = lowerCI,ymax = upperCI,fill = funding),inherit.aes=FALSE,alpha = 0.4) + 
  geom_line(data = newData,aes(x = scoutPerKm,y = nkilled,colour = funding))+
  geom_point() + 
  xlab("Scouts per km^2") + 
  ylab("Number of elephants killed in 2016")+
  NULL
```




